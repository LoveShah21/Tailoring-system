{% extends 'base.html' %}

{% block title %}Customer Dashboard - Tailoring Management System{% endblock %}

{% block nav_items %}
<li class="nav-item"><a class="nav-link active" href="{% url 'dashboard:home' %}"><i class="bi bi-house"></i>
        Dashboard</a></li>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-house"></i> Welcome, {{ user.get_full_name }}!</h2>
        <p class="text-muted">Track your orders and manage your profile.</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-white bg-primary h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6>My Orders</h6>
                        <h2 class="mb-0">{{ total_orders|default:"0" }}</h2>
                    </div>
                    <i class="bi bi-bag display-4 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-success h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6>Completed</h6>
                        <h2 class="mb-0">{{ completed_orders|default:"0" }}</h2>
                    </div>
                    <i class="bi bi-check-circle display-4 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-info h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6>In Progress</h6>
                        <h2 class="mb-0">{{ in_progress_orders|default:"0" }}</h2>
                    </div>
                    <i class="bi bi-hourglass-split display-4 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Orders</h5>
            </div>
            <div class="card-body">
                {% if recent_orders %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Garment</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in recent_orders %}
                            <tr>
                                <td>
                                    <a href="{% url 'orders:customer_order_detail' order.pk %}" class="text-decoration-none fw-bold">
                                        {{ order.order_number }}
                                    </a>
                                </td>
                                <td>{{ order.garment_type.name }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ order.current_status.display_label }}</span>
                                </td>
                                <td>{{ order.created_at|date:"M d, Y" }}</td>
                                <td>
                                    {% if order.bill and order.bill.invoice and not order.bill.invoice.is_fully_paid %}
                                        <button class="btn btn-sm btn-primary pay-now-btn" 
                                                data-bill-id="{{ order.bill.pk }}"
                                                data-amount="{{ order.bill.invoice.get_balance_due|floatformat:2 }}">
                                            Pay Now (â‚¹{{ order.bill.invoice.get_balance_due|floatformat:0 }})
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-4">No orders yet. Contact us to place your first order!</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'users:profile' %}" class="btn btn-outline-primary">
                        <i class="bi bi-person"></i> My Profile
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const payBtns = document.querySelectorAll('.pay-now-btn');
    
    payBtns.forEach(btn => {
        btn.addEventListener('click', async function() {
            const billId = this.dataset.billId;
            const amount = this.dataset.amount;
            
            try {
                // 1. Create Order
                const response = await fetch(`/payments/create/${billId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `amount=${amount}`
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                // 2. Open Razorpay
                const options = {
                    "key": data.key,
                    "amount": data.amount,
                    "currency": data.currency,
                    "name": "Tailoring System",
                    "description": "Bill Payment",
                    "order_id": data.order_id,
                    "handler": async function (response){
                        // 3. Verify Payment
                        const verifyResp = await fetch('/payments/verify/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `razorpay_payment_id=${response.razorpay_payment_id}&razorpay_order_id=${response.razorpay_order_id}&razorpay_signature=${response.razorpay_signature}`
                        });
                        
                        const verifyData = await verifyResp.json();
                        if (verifyData.success) {
                            alert('Payment successful!');
                            location.reload();
                        } else {
                            window.location.href = `/payments/failed/?error=${encodeURIComponent(verifyData.error)}`;
                        }
                    },
                    "theme": {
                        "color": "#3399cc"
                    }
                };
                
                const rzp1 = new Razorpay(options);
                rzp1.open();
                
            } catch (err) {
                console.error(err);
                alert('Something went wrong. Please try again.');
            }
        });
    });
});
</script>
{% endblock %}