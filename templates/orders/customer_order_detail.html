{% extends 'base.html' %}

{% block title %}Order #{{ order.order_number }} - Details{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard:home' %}">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Order #{{ order.order_number }}</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <h2>Order #{{ order.order_number }}</h2>
            <span class="badge bg-{{ order.current_status.color_code|default:'secondary' }} fs-6">
                {{ order.current_status.display_label }}
            </span>
        </div>
    </div>
</div>

<div class="row">
    <!-- Order Information -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Order Details</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-sm-6">
                        <label class="text-muted small">Garment Type</label>
                        <p class="fw-bold">{{ order.garment_type.name }}</p>
                    </div>
                    <div class="col-sm-6">
                        <label class="text-muted small">Order Date</label>
                        <p class="fw-bold">{{ order.created_at|date:"F d, Y" }}</p>
                    </div>
                    <div class="col-sm-6">
                        <label class="text-muted small">Expected Delivery</label>
                        <p class="fw-bold">{{ order.expected_delivery_date|date:"F d, Y" }}</p>
                    </div>
                     <div class="col-sm-6">
                        <label class="text-muted small">Special Instructions</label>
                        <p class="mb-0">{{ order.special_instructions|default:"None" }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status History -->
         <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Status Timeline</h5>
            </div>
            <ul class="list-group list-group-flush">
                {% for history in status_history %}
                <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">{{ history.to_status.display_label }}</span>
                            <br>
                            <small class="text-muted">{{ history.reason|default:"" }}</small>
                        </div>
                        <small class="text-muted">{{ history.changed_at|date:"M d, H:i" }}</small>
                    </div>
                </li>
                {% empty %}
                <li class="list-group-item text-muted">No status history available.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Sidebar: Financials & Actions -->
    <div class="col-md-4">
        <!-- Bill & Payment -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-receipt"></i> Payment & Billing</h5>
            </div>
            <div class="card-body">
                {% if order.bill %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Amount:</span>
                        <span class="fw-bold">₹{{ order.bill.total_amount }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Paid:</span>
                        <span class="text-success">₹{{ order.bill.amount_paid }}</span>
                    </div>
                    {% if order.bill.invoice %}
                         <div class="d-flex justify-content-between mb-3 border-top pt-2">
                            <span>Balance Due:</span>
                            <span class="fw-bold {% if order.bill.invoice.get_balance_due > 0 %}text-danger{% else %}text-success{% endif %}">
                                ₹{{ order.bill.invoice.get_balance_due }}
                            </span>
                        </div>
                        
                        <!-- Actions -->
                        <div class="d-grid gap-2">
                            {% if order.bill.invoice.get_balance_due > 0 %}
                             <button class="btn btn-primary pay-now-btn" 
                                    data-bill-id="{{ order.bill.pk }}"
                                    data-amount="{{ order.bill.invoice.get_balance_due|floatformat:2 }}">
                                Pay Now (₹{{ order.bill.invoice.get_balance_due|floatformat:0 }})
                            </button>
                            {% endif %}
                            
                             <a href="{% url 'billing:download_pdf' order.bill.invoice.pk %}" class="btn btn-outline-secondary">
                                <i class="bi bi-download"></i> Download Invoice
                            </a>
                        </div>
                    {% else %}
                        <p class="text-muted small mt-3">Invoice not yet generated.</p>
                    {% endif %}
                {% else %}
                    <p class="text-muted">Bill not yet generated.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Measurement Set -->
        {% if order.measurement_set %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-rulers"></i> Measurements</h5>
            </div>
            <div class="card-body">
                <p class="mb-1"><strong>Version:</strong> {{ order.measurement_set.version }}</p>
                <div class="text-muted small">Used for this order.</div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Razorpay Script (Reusable) -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const payBtns = document.querySelectorAll('.pay-now-btn');
    
    payBtns.forEach(btn => {
        btn.addEventListener('click', async function() {
            const billId = this.dataset.billId;
            const amount = this.dataset.amount;
            
            try {
                // 1. Create Order
                const response = await fetch(`/payments/create/${billId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `amount=${amount}`
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                // 2. Open Razorpay
                const options = {
                    "key": data.key,
                    "amount": data.amount,
                    "currency": data.currency,
                    "name": "Tailoring System",
                    "description": "Bill Payment",
                    "order_id": data.order_id,
                    "handler": async function (response){
                        // 3. Verify Payment
                        const verifyResp = await fetch('/payments/verify/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `razorpay_payment_id=${response.razorpay_payment_id}&razorpay_order_id=${response.razorpay_order_id}&razorpay_signature=${response.razorpay_signature}&recorded_by={{ user.id }}`
                        });
                        
                        const verifyData = await verifyResp.json();
                         if (verifyData.success) {
                            alert('Payment successful!');
                            location.reload();
                        } else {
                            window.location.href = `/payments/failed/?error=${encodeURIComponent(verifyData.error)}`;
                        }
                    },
                    "theme": {
                        "color": "#3399cc"
                    }
                };
                
                const rzp1 = new Razorpay(options);
                rzp1.open();
                
            } catch (err) {
                console.error(err);
                alert('Something went wrong. Please try again.');
            }
        });
    });
});
</script>
{% endblock %}
