{% extends 'base.html' %}

{% block title %}{{ order.order_number }} - Order Details{% endblock %}

{% block nav_items %}
<li class="nav-item"><a class="nav-link" href="{% url 'dashboard:home' %}"><i class="bi bi-speedometer2"></i>
        Dashboard</a></li>
<li class="nav-item"><a class="nav-link" href="{% url 'customers:customer_list' %}"><i class="bi bi-people"></i>
        Customers</a></li>
<li class="nav-item"><a class="nav-link active" href="{% url 'orders:order_list' %}"><i class="bi bi-cart"></i>
        Orders</a></li>
{% endblock %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'orders:order_list' %}">Orders</a></li>
            <li class="breadcrumb-item active">{{ order.order_number }}</li>
        </ol>
    </nav>
</div>

<div class="row">
    <!-- Left Column - Order Info -->
    <div class="col-md-8">
        <!-- Order Header -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-bag"></i> {{ order.order_number }}
                    {% if order.is_urgent %}<span class="badge bg-danger ms-2">Urgent</span>{% endif %}
                </h5>
                <div>
                    <a href="{% url 'orders:order_edit' order.pk %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%">Customer</th>
                                <td>
                                    <a href="{% url 'customers:customer_detail' order.customer.pk %}">
                                        {{ order.customer.user.get_full_name }}
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <th>Phone</th>
                                <td>{{ order.customer.phone_number }}</td>
                            </tr>
                            <tr>
                                <th>Garment Type</th>
                                <td>{{ order.garment_type.name }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th width="50%">Status</th>
                                <td>
                                    <span
                                        class="badge bg-{% if order.current_status.is_final_state %}success{% else %}primary{% endif %} fs-6">
                                        {{ order.current_status.display_label }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th>Expected Delivery</th>
                                <td>
                                    {{ order.expected_delivery_date|date:"F d, Y" }}
                                    {% if order.is_overdue %}<span class="badge bg-danger">Overdue</span>{% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Created</th>
                                <td>{{ order.created_at|date:"F d, Y H:i" }}</td>
                            </tr>
                        </table>
                    </div>
                </div>

                {% if order.special_instructions %}
                <div class="alert alert-info">
                    <strong>Special Instructions:</strong><br>
                    {{ order.special_instructions }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Work Types -->
        {% if work_types %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-gear"></i> Work Types</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Work Type</th>
                            <th class="text-end">Charge</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for wt in work_types %}
                        <tr>
                            <td>{{ wt.work_type.name }}</td>
                            <td class="text-end">₹{{ wt.extra_charge }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Material Allocations -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-box-seam"></i> Material Allocations</h6>
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#allocateModal">
                    <i class="bi bi-plus"></i> Allocate
                </button>
            </div>
            <div class="card-body">
                {% if allocations %}
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Fabric</th>
                            <th>Quantity</th>
                            <th>Cost</th>
                            <th>Allocated By</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for alloc in allocations %}
                        <tr>
                            <td>{{ alloc.fabric.name }} ({{ alloc.fabric.color }})</td>
                            <td>{{ alloc.quantity_meters }}m</td>
                            <td>₹{{ alloc.get_total_cost }}</td>
                            <td>{{ alloc.allocated_by.get_full_name|default:alloc.allocated_by.username }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted mb-0">No material allocated yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- Assignments -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-people"></i> Staff Assignments</h6>
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#assignModal">
                    <i class="bi bi-plus"></i> Assign
                </button>
            </div>
            <div class="card-body">
                {% if assignments %}
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Staff</th>
                            <th>Role</th>
                            <th>Assigned On</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for a in assignments %}
                        <tr>
                            <td>{{ a.staff.get_full_name }}</td>
                            <td><span class="badge bg-secondary">{{ a.role_type|title }}</span></td>
                            <td>{{ a.assigned_at|date:"M d, Y" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted mb-0">No staff assigned yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- Status History -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-clock-history"></i> Status History</h6>
            </div>
            <div class="card-body">
                {% if status_history %}
                <div class="timeline">
                    {% for h in status_history %}
                    <div class="d-flex mb-3">
                        <div class="flex-shrink-0">
                            <span class="badge bg-primary rounded-pill">{{ forloop.revcounter }}</span>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <strong>{{ h.from_status.display_label }}</strong> → <strong>{{ h.to_status.display_label }}</strong>
                            <br>
                            <small class="text-muted">
                                by {{ h.changed_by.get_full_name|default:h.changed_by.username }}
                                on {{ h.changed_at|date:"M d, Y H:i" }}
                            </small>
                            {% if h.change_reason %}
                            <br><small>Reason: {{ h.change_reason }}</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted mb-0">No status changes yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right Column - Actions -->
    <div class="col-md-4">
        <!-- Status Transition -->
        {% if valid_transitions %}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="bi bi-arrow-right-circle"></i> Change Status</h6>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'orders:order_transition' order.pk %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Move to:</label>
                        <select name="new_status" class="form-select" required>
                            {% for t in valid_transitions %}
                            <option value="{{ t.to_status.id }}">{{ t.to_status.display_label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason (optional):</label>
                        <textarea name="reason" class="form-control" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-check"></i> Update Status
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Quick Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Quick Info</h6>
            </div>
            <div class="card-body">
                <p><strong>Base Price:</strong> ₹{{ order.garment_type.base_price }}</p>
                <p><strong>Work Charges:</strong> ₹{{ order.get_total_work_type_charges }}</p>
                {% if order.is_urgent %}
                <p><strong>Urgency:</strong> {{ order.urgency_multiplier }}x multiplier</p>
                {% endif %}
            </div>
        </div>

        <!-- Danger Zone -->
        {% if user.is_superuser %}
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Danger Zone</h6>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'orders:order_delete' order.pk %}"
                    onsubmit="return confirm('Are you sure you want to delete this order?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger w-100">
                        <i class="bi bi-trash"></i> Delete Order
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Assign Modal -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'orders:order_assign' order.pk %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Assign Staff</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Staff Member</label>
                        {{ assignment_form.staff }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        {{ assignment_form.role_type }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        {{ assignment_form.notes }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Allocate Modal -->
<div class="modal fade" id="allocateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'orders:order_allocate' order.pk %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Allocate Material</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Fabric</label>
                        {{ allocation_form.fabric }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                         <div class="input-group">
                            {{ allocation_form.quantity }}
                            <span class="input-group-text">meters</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Allocate</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}